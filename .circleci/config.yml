#
# CircleCI 2.0 configuration file.
#
# Understanding CircleCI 'docker' executor.
#
# CircleCI uses "runner" container (created from specified Docker image)
# to checkout source code and run commands defined in this file.
# Application Docker containers (the ones defined in docker-compose.yml)
# run on *remote* docker server, started by CircleCI as a part of their stack.
# The "runner" container uses Docker client to control remote Docker server
# (when used locally, Docker bundles both client and server into a single
# "Docker" application, so you may not even know that these are two different
# services).
#
# Because Docker images use layers, it is possible to cache Docker images
# between builds to significantly speedup application provisioning for each
# job (it requires enabling of Docker Layer Caching feature in CircleCI by
# lodging a support request).
# https://circleci.com/docs/2.0/docker-layer-caching/
version: 2

################################################################################
# VARIABLES
################################################################################
# For YAML support of anchors and references, see http://blog.daemonl.com/2016/02/yaml.html
aliases:
  #-----------------------------------------------------------------------------
  # Per-project variables.
  #-----------------------------------------------------------------------------

  # Timezone of the runner container to ensure that DB cache key uses correct date.
  - &timezone "Australia/Melbourne"

  # SSH key fingerprint to deploy code.
  # Generate a separate SSH key for a user who has push permissions to
  # $DREVOPS_DEPLOY_ARTIFACT_GIT_REMOTE repo with `ssh-keygen -m PEM -t rsa -C "deployer@example.com"
  # command and add private key under "SSH Permissions" in CircleCI UI.
  - &deploy_ssh_fingerprint "bc:87:4a:74:cf:e0:02:4e:34:aa:16:b5:c3:6f:89:cd"

  # SSH key fingerprint to deploy code to civictheme.
  - &deploy_ssh_fingerprint1 "b7:05:38:98:47:28:c7:1f:d8:6d:7a:75:3c:13:5b:af"

  # SSH key fingerprint to deploy code to civictheme_library.
  - &deploy_ssh_fingerprint2 "12:06:0e:75:93:10:3b:b4:59:fe:11:75:11:22:20:dd"

  # SSH key fingerprint to deploy code to civictheme_govcms.
  - &deploy_ssh_fingerprint3 "a9:33:24:68:20:f9:91:24:b8:38:c5:f3:b6:4b:34:5d"

  # SSH key fingerprint to deploy code to civictheme_content.
  - &deploy_ssh_fingerprint4 "a3:41:d1:47:85:4c:5d:12:9c:4c:1f:a2:67:d3:a5:3f"

  # SSH key fingerprint to deploy code to civictheme_admin.
  - &deploy_ssh_fingerprint5 "ab:76:65:9f:76:02:c2:b9:2a:bc:81:db:a0:c6:37:59"

  # SSH key fingerprint to deploy code to civictheme_migrate.
  - &deploy_ssh_fingerprint6 "2b:61:1c:7c:d1:f8:9b:63:dc:a7:10:c1:d6:0a:4f:b8"

  # SSH key fingerprint to deploy code to Drupal.org
  - &deploy_ssh_fingerprint7 "47:f9:29:8b:9b:1b:e9:66:5d:b3:f6:dd:e7:60:d1:f9"

  # SSH key fingerprint to mirror code.
  - &git_mirror_ssh_fingerprint "88:48:44:13:07:7a:a7:da:8c:fb:5e:a7:62:45:73:c4"

  #-----------------------------------------------------------------------------
  # Optional variables.
  #-----------------------------------------------------------------------------

  # CI runner resource class.
  # @see https://circleci.com/docs/2.0/configuration-reference/#resource_class
  # Change to 'large' for faster builds. Requires lodging a support request
  # with CircleCI o enable this feature.
  - &resource_class large

  # Docker Layer Caching allows to significantly speed up builds by caching
  # images built during previous runs.
  # @see https://circleci.com/docs/2.0/docker-layer-caching/
  # Change to 'true' (without single quotes) to enable. Requires lodging a
  # support request with CircleCI to enable this feature.
  - &docker_layer_caching false

  #-----------------------------------------------------------------------------

  # Shared configuration applied to each job.
  - &container_config
    #
    # Location of checked-out files within "runner" container.
    working_directory: &working_directory /root/project
    environment:
      DREVOPS_DEPLOY_SSH_FINGERPRINT: *deploy_ssh_fingerprint
      DEPLOY_SSH_FINGERPRINT1: *deploy_ssh_fingerprint1
      DEPLOY_SSH_FINGERPRINT2: *deploy_ssh_fingerprint2
      DEPLOY_SSH_FINGERPRINT3: *deploy_ssh_fingerprint3
      DEPLOY_SSH_FINGERPRINT4: *deploy_ssh_fingerprint4
      DEPLOY_SSH_FINGERPRINT5: *deploy_ssh_fingerprint5
      DEPLOY_SSH_FINGERPRINT6: *deploy_ssh_fingerprint6
      DEPLOY_SSH_FINGERPRINT7: *deploy_ssh_fingerprint7
      GIT_MIRROR_SSH_FINGERPRINT: *git_mirror_ssh_fingerprint
    docker:
      - image: drevops/ci-builder
        auth:
          username: $DREVOPS_DOCKER_REGISTRY_USERNAME
          password: $DREVOPS_DOCKER_REGISTRY_TOKEN
        environment:
          # Set timezone to ensure that executed operations use correct timestamps.
          TZ: *timezone
          # Always answer 'y' to any confirmation questions.
          DREVOPS_AHOY_CONFIRM_RESPONSE: 'y'
          # Directory to store code exported between jobs.
          DREVOPS_EXPORT_CODE_DIR: &drevops_build_export_dir /workspace/code
          # Directory to store test results.
          DREVOPS_TEST_REPORTS_DIR: &drevops_test_reports_dir /tmp/tests
          # Directory to store test artifacts.
          DREVOPS_TEST_ARTIFACT_DIR: &drevops_test_artifact_dir /tmp/artifacts
          # Use compact error reporting format.
          DREVOPS_TEST_BEHAT_FORMAT: progress_fail
          # Directory to use for artifact deployments.
          DREVOPS_DEPLOY_ARTIFACT_SRC: *drevops_build_export_dir
          # Source code location for artifact deployments.
          DREVOPS_DEPLOY_ARTIFACT_ROOT: *working_directory
          # Report file location for artifact deployments.
          DREVOPS_DEPLOY_ARTIFACT_REPORT_FILE: /tmp/artifacts/deployment_report.txt
          # Check only minimal stack requirements.
          DREVOPS_DOCTOR_CHECK_MINIMAL: 1
    resource_class: *resource_class

  # Set up remote docker.
  - &step_setup_remote_docker
    setup_remote_docker:
      docker_layer_caching: *docker_layer_caching
      version: 19.03.13

  # Process the codebase to be run in CI environment.
  - &step_process_codebase
    run:
      name: Process codebase to run in CI
      command: |
        # Remove lines containing '###' and uncomment comments starting with '##'.
        sed -i -e "/###/d" docker-compose.yml && sed -i -e "s/##//" docker-compose.yml
        # Alter build for an alternative build setup.
        if [ "$CIVICTHEME_INSTALL_SIBLING" = "1" ]; then cp -f .docker/Dockerfile.cli.sibling .docker/Dockerfile.cli; fi
        if [ "$CIVICTHEME_SKIP_LIBRARY_INSTALL" = "1" ]; then cp -f .docker/Dockerfile.cli.onlytheme .docker/Dockerfile.cli; fi

################################################################################
# JOBS
################################################################################

job-build: &job-build
  parallelism: 2
  steps:
    - attach_workspace:
        at: /workspace
    - checkout
    - *step_process_codebase
    - *step_setup_remote_docker
    - run:
        name: Lint docs spelling
        command: ./scripts/lint-spelling.sh
    - run:
        name: Build site
        command: ahoy build
        no_output_timeout: 30m
    - run:
        name: Lint code
        command: ahoy lint
    - run:
        name: Lint theme config
        command: ahoy lint config
    - run:
        name: Run tooling tests
        command: ./scripts/test-tooling.sh
    - run:
        name: Run tests
        command: 'if [ $CIRCLE_NODE_TOTAL -gt 1 ]; then export DREVOPS_TEST_BEHAT_PARALLEL_INDEX=$CIRCLE_NODE_INDEX; fi && ahoy test'
    - run:
        name: Process test logs and artifacts
        command: |
          [ -n "$(docker-compose ps -q cli)" ] && [ -n "$(docker ps -q --no-trunc | grep "$(docker-compose ps -q cli)")" ] && (
            ahoy cli mkdir -p "${DREVOPS_TEST_REPORTS_DIR}" && docker cp "$(docker-compose ps -q cli)":"${DREVOPS_TEST_REPORTS_DIR}" "${DREVOPS_TEST_REPORTS_DIR}"
            ahoy cli mkdir -p "${DREVOPS_TEST_ARTIFACT_DIR}" && docker cp "$(docker-compose ps -q cli)":"${DREVOPS_TEST_ARTIFACT_DIR}" "${DREVOPS_TEST_ARTIFACT_DIR}"
          ) || true
        when: always
    - store_test_results:
        path: *drevops_test_reports_dir
    - store_artifacts:
        path: *drevops_test_artifact_dir
    - persist_to_workspace:
        root: /workspace
        paths:
          - code

# Exactly as above, but no persisting of the code at the end of the build.
# @see https://github.com/yaml/yaml/issues/35
job-build-no-persist: &job-build-no-persist
  parallelism: 2
  steps:
    - attach_workspace:
        at: /workspace
    - checkout
    - *step_process_codebase
    - *step_setup_remote_docker
    - run:
        name: Lint docs spelling
        command: ./scripts/lint-spelling.sh
    - run:
        name: Build site
        command: ahoy build
        no_output_timeout: 30m
    - run:
        name: Lint code
        command: ahoy lint
    - run:
        name: Lint theme config
        # Drupal 10 has different configuration export logic which results in config differences.
        command: ahoy lint config || true
    - run:
        name: Run tooling tests
        command: ./scripts/test-tooling.sh
    - run:
        name: Run tests
        command: 'if [ $CIRCLE_NODE_TOTAL -gt 1 ]; then export DREVOPS_TEST_BEHAT_PARALLEL_INDEX=$CIRCLE_NODE_INDEX; fi && ahoy test'
    - run:
        name: Process test logs and artifacts
        command: |
          [ -n "$(docker-compose ps -q cli)" ] && [ -n "$(docker ps -q --no-trunc | grep "$(docker-compose ps -q cli)")" ] && (
            ahoy cli mkdir -p "${DREVOPS_TEST_REPORTS_DIR}" && docker cp "$(docker-compose ps -q cli)":"${DREVOPS_TEST_REPORTS_DIR}" "${DREVOPS_TEST_REPORTS_DIR}"
            ahoy cli mkdir -p "${DREVOPS_TEST_ARTIFACT_DIR}" && docker cp "$(docker-compose ps -q cli)":"${DREVOPS_TEST_ARTIFACT_DIR}" "${DREVOPS_TEST_ARTIFACT_DIR}"
          ) || true
        when: always
    - store_test_results:
        path: *drevops_test_reports_dir
    - store_artifacts:
        path: *drevops_test_artifact_dir

job-mirror: &job-mirror
  steps:
    - attach_workspace:
        at: /workspace
    - add_ssh_keys:
        fingerprints:
          - *deploy_ssh_fingerprint
          - *git_mirror_ssh_fingerprint
    - checkout
    - *step_process_codebase
    - checkout
    - run:
        name: Re-deploy environment.
        # We do not have a standalone branch for 'default' profile because we
        # are using `develop` branch to build with 'default' profile.
        command: |
          set -x
          branches=()
          branches+=(content/corporate)
          branches+=(content/government)
          branches+=(content/highereducation)
          branches+=(content/migration)
          if [ "$MIRROR_CONTENT_BRANCHES_PROCEED" == "1" ]; then
            for branch in "${branches[@]}"
            do
              GIT_MIRROR_BRANCH_DST="${branch}" GIT_MIRROR_BRANCH=develop ./scripts/git-mirror.sh
              sleep 5
              DREVOPS_DEPLOY_LAGOON_BRANCH="${branch}" DEPLOY_ACTION=deploy_override_db ahoy deploy
            done
          fi

jobs:

  # Drupal 9, minimal profile.
  build-drupal9-minimal:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: minimal
      DREVOPS_TEST_BEHAT_TAGS: smoke
    <<: *job-build-no-persist

  # Drupal 9, minimal profile, 'corporate' content profile.
  build-drupal9-minimal-corporate:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: minimal
      CIVICTHEME_CONTENT_PROFILE: corporate
      CIVICTHEME_SKIP_SUBTHEME_ACTIVATION: 1
      CIVICTHEME_SKIP_LIBRARY_INSTALL: 1
      DREVOPS_TEST_BEHAT_TAGS: smoke
    <<: *job-build-no-persist

  # Drupal 9, minimal profile, 'highereducation' content profile.
  build-drupal9-minimal-highereducation:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: minimal
      CIVICTHEME_CONTENT_PROFILE: highereducation
      CIVICTHEME_SKIP_SUBTHEME_ACTIVATION: 1
      CIVICTHEME_SKIP_LIBRARY_INSTALL: 1
      DREVOPS_TEST_BEHAT_TAGS: smoke
    <<: *job-build-no-persist

  # Drupal 9, minimal profile, 'government' content profile.
  build-drupal9-minimal-government:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: minimal
      CIVICTHEME_CONTENT_PROFILE: government
      CIVICTHEME_SKIP_SUBTHEME_ACTIVATION: 1
      CIVICTHEME_SKIP_LIBRARY_INSTALL: 1
      DREVOPS_TEST_BEHAT_TAGS: smoke
    <<: *job-build-no-persist

  # Drupal 9, GovCMS profile, subtheme. Longest test run.
  build-drupal9-govcms:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: govcms
      DREVOPS_TEST_BEHAT_PROFILE: subtheme
    <<: *job-build-no-persist

  # Drupal 9, GovCMS profile, subtheme is a sibling.
  build-drupal9-govcms-sibling:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: govcms
      DREVOPS_TEST_BEHAT_TAGS: smoke
      CIVICTHEME_INSTALL_SIBLING: 1
    <<: *job-build-no-persist

  # Drupal 9, GovCMS profile, no subtheme.
  build-drupal9-govcms-no-subtheme:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: govcms
      CIVICTHEME_SKIP_SUBTHEME_ACTIVATION: 1
      CIVICTHEME_SKIP_LIBRARY_INSTALL: 1
    <<: *job-build

  # Drupal 10, minimal profile.
  build-drupal10-minimal:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: minimal
      DREVOPS_DRUPAL_VERSION: 10
      DREVOPS_TEST_BEHAT_TAGS: smoke
    <<: *job-build-no-persist

  # Drupal 10, minimal profile, no subtheme.
  build-drupal10-minimal-no-subtheme:
    <<: *container_config
    environment:
      DREVOPS_DRUPAL_PROFILE: minimal
      DREVOPS_DRUPAL_VERSION: 10
      CIVICTHEME_SKIP_SUBTHEME_ACTIVATION: 1
      CIVICTHEME_SKIP_LIBRARY_INSTALL: 1
      DREVOPS_TEST_FUNCTIONAL_GROUP: site:functional,civictheme:functional:update
    <<: *job-build-no-persist

  # Mirror and redeploy content profiles.
  mirror-into-content-branches:
    <<: *container_config
    <<: *job-mirror

  # Deploy primary branches.
  deploy: &job_deploy
    <<: *container_config
    steps:
      #
      # Workspace now contains previously built application code artifact.
      - attach_workspace:
          at: /workspace
      #
      # Add SSH key into "runner" container to have "push" access to remote
      # repository.
      - add_ssh_keys:
          fingerprints:
            - *deploy_ssh_fingerprint
      - checkout
      - *step_process_codebase
      - run:
          command: |
            DREVOPS_DEPLOY_BRANCH="$CIRCLE_BRANCH" \
            DREVOPS_DEPLOY_PR="$(echo $CIRCLE_PULL_REQUEST | cut -d'/' -f 7)" \
            DREVOPS_DEPLOY_PR_HEAD=$CIRCLE_SHA1 \
            ahoy deploy
          no_output_timeout: 30m
      - store_artifacts:
          path: *drevops_test_artifact_dir

  # Deploy tags.
  deploy_tags: &job_deploy_tags
    <<: *container_config
    steps:
      #
      # Workspace now contains previously built application code artifact.
      - attach_workspace:
          at: /workspace
      #
      # Add SSH key into "runner" container to have "push" access to remote
      # repository.
      - add_ssh_keys:
          fingerprints:
            - *deploy_ssh_fingerprint1
            - *deploy_ssh_fingerprint2
            - *deploy_ssh_fingerprint3
            - *deploy_ssh_fingerprint4
            - *deploy_ssh_fingerprint5
            - *deploy_ssh_fingerprint6
            - *deploy_ssh_fingerprint7
      - checkout
      - *step_process_codebase
      - run:
          name: Deploy release to CivicTheme Drupal theme repository.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT1 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@github.com:salsadigitalauorg/civictheme.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=master \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/themes/contrib/civictheme" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - run:
          name: Deploy release to Drupal.org.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT7 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@git.drupal.org:project/civictheme.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=1.x \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/themes/contrib/civictheme" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - run:
          name: Deploy release to CivicTheme Library repository.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT2 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@github.com:salsadigitalauorg/civictheme_library.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=master \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/themes/contrib/civictheme/civictheme_library" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - run:
          name: Deploy release to CivicTheme GovCMS repository.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT3 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@github.com:salsadigitalauorg/civictheme_govcms.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=master \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/modules/custom/civictheme_govcms" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - run:
          name: Deploy release to CivicTheme Content repository.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT4 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@github.com:salsadigitalauorg/civictheme_content.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=master \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/modules/custom/civictheme_content" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - run:
          name: Deploy release to CivicTheme Admin repository.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT5 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@github.com:salsadigitalauorg/civictheme_admin.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=master \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/modules/custom/civictheme_admin" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - run:
          name: Deploy release to CivicTheme Migrate repository.
          command: |
            DEPLOY_SSH_FINGERPRINT=$DEPLOY_SSH_FINGERPRINT6 \
            DEPLOY_CODE_RELEASE_REMOTE_REPO=git@github.com:salsadigitalauorg/civictheme_migrate.git \
            DEPLOY_CODE_RELEASE_REMOTE_BRANCH=master \
            DEPLOY_CODE_RELEASE_SRC_DIR="${DREVOPS_EXPORT_CODE_DIR}/docroot/modules/custom/civictheme_migrate" \
            ./scripts/deploy-code-release.sh
          no_output_timeout: 30m
      - store_artifacts:
          path: *drevops_test_artifact_dir

################################################################################
# WORKFLOWS
################################################################################
workflows:
  version: 2
  #
  # Commit workflow. Runs for every commit push to the remote repository.
  commit:
    jobs:
      - build-drupal9-govcms:
          filters:
            branches:
              only: /develop|release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal9-minimal:
          filters:
            branches:
              only: /develop|release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal9-minimal-corporate:
          filters:
            branches:
              only: /^release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal9-minimal-highereducation:
          filters:
            branches:
              only: /^release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal9-minimal-government:
          filters:
            branches:
              only: /^release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal9-govcms-sibling:
          filters:
            branches:
              only: /^release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal9-govcms-no-subtheme:
          filters:
            branches:
              ignore: /^content\/.*/
            tags:
              only: /.*/
      - build-drupal10-minimal:
          filters:
            branches:
              only: /develop|release\/.*|hotfix\/.*/
            tags:
              only: /.*/
      - build-drupal10-minimal-no-subtheme:
          filters:
            branches:
              ignore: /^content\/.*/
            tags:
              only: /.*/
      - deploy:
          requires:
            - build-drupal9-govcms-no-subtheme
            - build-drupal10-minimal-no-subtheme
          filters:
            branches:
              # Allowed branches:
              # - main, master, develop, ci, cisomething
              # - deps/*
              # - release/123, release/123.456, release/123.456.789, release/123.456.789-rc123
              # - hotfix/123, hotfix/123.456, hotfix/123.456.789
              # - feature/description, feature/123-description, but not feature/9.x-description or feature/7.x-description
              only: /main|master|develop|project\/uno|ci.*|deps\/.*|(release\/)?[0-9]+(\.[0-9]+)+(-rc[0-9]+)?|(hotfix\/)?[0-9]+(\.[0-9]+)+(-rc[0-9]+)?|feature\/(?!7.x-|8.x-|9.x-)[a-zA-z0-9\-\.\,]+/
            tags:
              ignore: /.*/
      - deploy_tags:
          requires:
            - build-drupal9-govcms
            - build-drupal9-minimal
            - build-drupal9-minimal-corporate
            - build-drupal9-minimal-highereducation
            - build-drupal9-minimal-government
            - build-drupal9-govcms-sibling
            - build-drupal9-govcms-no-subtheme
            - build-drupal10-minimal
            - build-drupal10-minimal-no-subtheme
          filters:
            branches:
              ignore: /.*/
            tags:
              # Allowed tags: 1, 123, 123.456, 123.456.789, 123.456.789-rc123
              only: /^[0-9]+(\.[0-9]+)+(-rc[0-9]+)?$/
      - mirror-into-content-branches:
          requires:
            - build-drupal9-minimal
            - build-drupal9-govcms-no-subtheme
            - build-drupal9-govcms
            - build-drupal10-minimal
            - build-drupal10-minimal-no-subtheme
          filters:
            branches:
              only: develop
            tags:
              ignore: /.*/
