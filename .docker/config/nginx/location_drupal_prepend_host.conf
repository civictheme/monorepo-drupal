# Set HTTP_HOST for PHP using canonical host from CDN headers
# Priority: HTTP_QUANT_ORIG_HOST > HTTP_X_FORWARDED_HOST > original Host header (preserving port)

# Default to the incoming Host header so non-standard ports stay intact (e.g. :8080)
set $final_host $http_host;

# Use X-Forwarded-Host when provided (reverse proxies)
if ($http_x_forwarded_host != "") {
    set $final_host $http_x_forwarded_host;
}

# Override with Quant-Orig-Host when available
if ($http_quant_orig_host != "") {
    set $final_host $http_quant_orig_host;
}

# Extract first host from comma-separated X-Forwarded-Host values
if ($final_host ~ "^([^,\s]+)") {
    set $final_host $1;
}

# Always pass the calculated host; without override it matches the original Host header
fastcgi_param HTTP_HOST $final_host;
